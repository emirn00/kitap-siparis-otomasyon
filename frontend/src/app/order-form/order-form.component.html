<div class="order-form-container">
  <button class="profile-button" (click)="goToProfile()" [attr.aria-label]="'profile' | translate" type="button">
    {{ 'profile' | translate }}
  </button>

  <div class="hueber-header">
    <div class="logo-container">
      <h1 class="hueber-logo">HUEBER</h1>
      <h2 class="header-subtitle">{{ 'orderTitle' | translate }}</h2>
      <a routerLink="/yardim" class="help-link">{{ 'help' | translate }}</a>
    </div>
  </div>

  <mat-card class="form-card">
    <div class="intro-section">
      <p class="intro-text">
        <strong>{{ 'orderIntro1' | translate }}</strong><br><br>
        {{ 'orderIntro2' | translate }}<br><br>
        <em>{{ 'orderIntro3' | translate }}</em><br><br>
        <strong>{{ 'orderIntro4' | translate }}</strong><br>
        Nurten Karadağ - 0552 614 58 57<br>
        Merve Baycan - 0541 614 58 57
      </p>
    </div>

    <mat-card-content>
      <form [formGroup]="orderForm" *ngIf="!showSummary">
        <!-- User Information (Auto-filled) -->
        <div class="user-info-banner" *ngIf="userInfo">
          <div class="info-group">
            <span class="label">{{ 'fullName' | translate }}:</span>
            <span class="value">{{ userInfo.fullName }}</span>
          </div>
          <div class="info-group">
            <span class="label">{{ 'email' | translate }}:</span>
            <span class="value">{{ userInfo.email }}</span>
          </div>
          <div class="info-group">
            <span class="label">{{ 'phone' | translate }}:</span>
            <span class="value">{{ userInfo.phoneNumber }}</span>
          </div>
        </div>

        <div class="form-section">
          <div class="form-row">
            <mat-form-field appearance="outline" class="form-field">
              <mat-label>{{ 'school' | translate }}</mat-label>
              <input matInput formControlName="school" [placeholder]="'schoolPlaceholder' | translate">
              <mat-error *ngIf="school?.hasError('required')">{{ 'requiredSchool' | translate }}</mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="form-field">
              <mat-label>{{ 'city' | translate }}</mat-label>
              <input matInput formControlName="city" [placeholder]="'cityPlaceholder' | translate">
              <mat-error *ngIf="city?.hasError('required')">{{ 'requiredCity' | translate }}</mat-error>
            </mat-form-field>
          </div>
        </div>

        <div class="form-section">
          <h3 class="section-title">{{ 'workingBooks' | translate }}</h3>

          <mat-form-field appearance="outline" class="form-field full-width">
            <mat-label>{{ 'workingBooksPlaceholder' | translate }}</mat-label>
            <textarea matInput formControlName="workingBooks"
              [placeholder]="'workingBooksPlaceholder' | translate" rows="3"></textarea>
            <mat-error *ngIf="workingBooks?.hasError('required')">{{ 'requiredField' | translate }}</mat-error>
          </mat-form-field>
        </div>

        <div class="form-section">
          <h3 class="section-title">{{ 'needCodes' | translate }}</h3>

          <p *ngIf="booksLoading" class="books-loading">{{ 'booksLoading' | translate }}</p>
          <p *ngIf="booksError" class="books-error">{{ booksError }}</p>

          <div class="books-grid" *ngIf="!booksLoading && books.length > 0">
            <mat-card class="book-card" *ngFor="let book of books">
              <div class="book-image-container">
                <img [src]="book.imageUrl" [alt]="book.name" class="book-image" (error)="onImageError($event)">
                <div class="book-level-badge">{{ book.level }}</div>
              </div>
              <mat-checkbox [checked]="book.selectedForCodes" (change)="onBookChange(book, $event)" color="accent"
                class="book-checkbox">
                <span class="book-name">{{ book.name }}</span>
              </mat-checkbox>
            </mat-card>
          </div>
        </div>

        <div class="form-actions">
          <button mat-raised-button color="primary" (click)="onSubmit()"
            [disabled]="orderForm.invalid || selectedBooksFormArray.length === 0" class="submit-button">
            {{ 'continueBtn' | translate }}
          </button>
        </div>
      </form>

      <div *ngIf="showSummary" class="summary-section">
        <h3 class="summary-title">{{ 'summaryTitle' | translate }}</h3>

        <mat-card class="summary-card">
          <mat-card-content>
            <div class="summary-item" *ngIf="userInfo">
              <div class="summary-content">
                <strong>{{ 'fullName' | translate }}:</strong>
                <span>{{ userInfo.fullName }}</span>
              </div>
            </div>

            <div class="summary-item" *ngIf="userInfo">
              <div class="summary-content">
                <strong>{{ 'email' | translate }}:</strong>
                <span>{{ userInfo.email }}</span>
              </div>
            </div>

            <div class="summary-item" *ngIf="userInfo">
              <div class="summary-content">
                <strong>{{ 'phone' | translate }}:</strong>
                <span>{{ userInfo.phoneNumber }}</span>
              </div>
            </div>

            <div class="summary-item">
              <div class="summary-content">
                <strong>{{ 'school' | translate }}</strong>
                <span>{{ orderForm.value.school }}</span>
              </div>
            </div>

            <div class="summary-item">
              <div class="summary-content">
                <strong>{{ 'city' | translate }}:</strong>
                <span>{{ orderForm.value.city }}</span>
              </div>
            </div>

            <mat-divider></mat-divider>

            <div class="summary-item">
              <div class="summary-content">
                <strong>{{ 'workingBooks' | translate }}</strong>
                <span>{{ orderForm.value.workingBooks }}</span>
              </div>
            </div>

            <mat-divider></mat-divider>

            <div class="summary-item books-summary">
              <div class="summary-content">
                <strong>{{ 'books' | translate }}:</strong>
                <mat-list class="books-list">
                  <mat-list-item *ngFor="let bookName of getSelectedBookNames()">
                    <div matLine>{{ bookName }}</div>
                  </mat-list-item>
                </mat-list>
              </div>
            </div>
          </mat-card-content>
        </mat-card>

        <div *ngIf="orderError" class="order-error">{{ orderError }}</div>
        <div class="summary-actions">
          <button mat-stroked-button color="primary" (click)="onBack()" class="back-button" [disabled]="orderSubmitting">
            {{ 'back' | translate }}
          </button>
          <button mat-raised-button color="primary" (click)="onConfirm()" class="confirm-button"
            [disabled]="orderSubmitting">
            {{ orderSubmitting ? ('save' | translate) + '…' : ('confirm' | translate) }}
          </button>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>